<template>
    <template if:true={showProducts}>

        <template if:true={existingWorkOrderLineItems}>
            <p class="slds-p-horizontal_small">
                <lightning-datatable 
                    key-field="id" 
                    data={existingWorkOrderLineItems} 
                    columns={columns}
                    hide-checkbox-column 
                    onrowaction={handleRowAction}>
                </lightning-datatable>
            </p>
        </template>

        <template if:true={showAll}>
            <lightning-button 
                variant="brand" 
                class="slds-align_absolute-center" 
                onclick={toggleTemplates}
                name="Add More" 
                style="margin-top:10px;" 
                label="Add More" 
                disabled={isShowLoader}>
            </lightning-button>
        </template>

        <template if:true={showRow}>
            <lightning-card>

                <template for:each={itemList} for:item="item" for:index="index">
                    <div class="tile" key={item.id}>
                        <lightning-record-edit-form 
                            object-api-name="WorkOrderLineItem" 
                            onsuccess={handleSuccess} 
                            onerror={handleError}>

                            <lightning-messages></lightning-messages>

                            <lightning-layout multiple-rows>

                                <!-- Work Order ID (hidden) -->
                                <lightning-layout-item size="12" large-device-size="2" style="display: none;">
                                    <lightning-input-field 
                                        field-name="WorkOrderId" 
                                        variant="label-stacked" 
                                        disabled
                                        value={recordId}>
                                    </lightning-input-field>
                                </lightning-layout-item>

                                <!-- Parts Category -->
                                <lightning-layout-item size="12" large-device-size="2" class="slds-align_absolute-center">
                                    <lightning-combobox 
                                        label="Parts Category"
                                        value={item.rrPartsCategory}
                                        options={filteredReplacementTypeOptions}
                                        data-id={index}
                                        data-fieldname="RR_Parts_Category__c"
                                        onchange={handlepicklistchange}
                                        access-key={item.id} 
                                        id={index} 
                                        required>
                                    </lightning-combobox>
                                    <lightning-input-field 
                                        field-name="RR_Parts_Category__c" 
                                        variant="label-stacked"
                                        onchange={handlepicklistchange} 
                                        access-key={item.id} 
                                        id={index} 
                                        data-id={index}
                                        data-fieldname="RR_Parts_Category__c"  
                                        style="display:none" 
                                        required>
                                    </lightning-input-field>
                                </lightning-layout-item>

                                <!-- Product Selection -->
                                <lightning-layout-item size="12" large-device-size="2" class="slds-align_absolute-center">
                                    <div class="slds-form-element">
                                        <lightning-input-field 
                                            field-name="RR_Product__c" 
                                            variant="label-stacked"
                                            data-id={index} 
                                            name="product" 
                                            onchange={handleProductselection}
                                            access-key={item.id} 
                                            id={index} 
                                            required>
                                        </lightning-input-field>

                                        <!-- Error Message -->
                                        <template if:true={item.errorMessage}>
                                            <div class="slds-form-element__help slds-text-color_error">
                                                {item.errorMessage}
                                            </div>
                                        </template>
                                    </div>
                                </lightning-layout-item>

                                <!-- Product Code -->
                                <lightning-layout-item size="12" large-device-size="2" class="slds-align_absolute-center">
                                    <lightning-input label="Product Code" value={item.productCode} disabled></lightning-input>
                                </lightning-layout-item>

                                <!-- Available Quantity -->
                                <lightning-layout-item size="12" large-device-size="2" class="slds-align_absolute-center">
                                    <lightning-input label="Available Quantity" value={item.availableQuantity} disabled></lightning-input>
                                </lightning-layout-item>

                                <!-- Additional Fields -->
                                <template if:true={item.showAdditionalFields}>

                                    <!-- Replacement Type -->
                                    <lightning-layout-item size="12" large-device-size="2" class="slds-align_absolute-center">
                                        <lightning-input-field 
                                            field-name="Replacement_Type__c" 
                                            variant="label-stacked"
                                            onchange={handlepicklistchange} 
                                            access-key={item.id} 
                                            id={index}
                                            data-id={index} 
                                            data-fieldname="Replacement_Type__c"
                                            required={item.isElectricalValueRequired}>
                                        </lightning-input-field>
                                    </lightning-layout-item>

                                    <!-- Approved Insurance % -->
                                    <lightning-layout-item size="12" large-device-size="2" class="slds-align_absolute-center">
                                        <lightning-input-field 
                                            field-name="Approved_Insurance__c" 
                                            variant="label-stacked"
                                            data-id={index}
                                            access-key={item.id}
                                            id={index}
                                            data-fieldname="Approved_Insurance__c"
                                            label="Approved Insurance (%)"
                                            type="percent"
                                            step="0.01">
                                        </lightning-input-field>
                                    </lightning-layout-item>

                                </template>

                                <!-- Electrical Value -->
                                <lightning-layout-item size="12" large-device-size="1" class="slds-align_absolute-center">
                                    <lightning-input-field 
                                        field-name="Electrical_Value__c" 
                                        variant="label-stacked"
                                        access-key={item.id} 
                                        id={index} 
                                        data-id={index}
                                        data-fieldname="Electrical_Value__c" 
                                        required={item.isElectricalValueRequired}>
                                    </lightning-input-field>
                                </lightning-layout-item>

                                <!-- Part Description -->
                                <lightning-layout-item size="12" large-device-size="1" class="slds-align_absolute-center">
                                    <lightning-input-field 
                                        field-name="Part_Description__c" 
                                        variant="label-stacked"
                                        access-key={item.id} 
                                        id={index} 
                                        data-id={index}
                                        required={item.isPartDescriptionRequired}>
                                    </lightning-input-field>
                                </lightning-layout-item>

                                <!-- Quantity -->
                                <lightning-layout-item size="12" large-device-size="1" class="slds-align_absolute-center">
                                    <lightning-input-field 
                                        field-name="Quantity" 
                                        variant="label-stacked"
                                        access-key={item.id} 
                                        id={index} 
                                        data-id={index} 
                                        required 
                                        value={item.Quantity}
                                        onchange={handleQuantityChange}>
                                    </lightning-input-field>
                                </lightning-layout-item>

                                <!-- Add/Delete Row Icons -->
                                <lightning-layout-item class="slds-align_absolute-center" size="12" large-device-size="1">
                                    <lightning-icon 
                                        class="margin-icon" 
                                        icon-name="action:new" 
                                        access-key={item.id}
                                        id={index} 
                                        data-id={index} 
                                        alternative-text="Add Row" 
                                        size="small"
                                        title="Add Row" 
                                        onclick={addRow}>
                                    </lightning-icon>
                                    <lightning-icon 
                                        class="margin-icon" 
                                        icon-name="action:delete" 
                                        access-key={item.id}
                                        id={index} 
                                        data-id={index} 
                                        alternative-text="Delete Row" 
                                        size="small"
                                        title="Delete Row" 
                                        onclick={removeRow}>
                                    </lightning-icon>
                                </lightning-layout-item>

                            </lightning-layout>
                        </lightning-record-edit-form>
                    </div>
                </template>

                <!-- Submit & Cancel Buttons -->
                <lightning-layout style="margin-top: 15px;">
                    <div class="slds-align_absolute-center">
                        <lightning-button 
                            variant="brand-outline" 
                            onclick={toggleTemplates} 
                            name="Cancel"
                            style="margin:10px;" 
                            label="Cancel">
                        </lightning-button>
                        <lightning-button 
                            variant="brand" 
                            onclick={handleSubmit} 
                            name="Submit" 
                            type="Submit"
                            label="Submit" 
                            disabled={isSubmitDisabled}>
                        </lightning-button>
                    </div>
                </lightning-layout>

            </lightning-card>

            <!-- Loader -->
            <template if:true={isShowLoader}>
                <div class="exampleHolder">
                    <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
                </div>
            </template>

        </template>
    </template>
</template>