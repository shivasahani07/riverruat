<apex:page showHeader="false" sidebar="false" controller="GatePassController">
    <apex:includeScript value="/soap/ajax/43.0/connection.js"/>
    <apex:includeScript value="/soap/ajax/43.0/apex.js"/>
    
    <style>
        body {
        font-family: "Segoe UI", Roboto, sans-serif;
        background-color: #f2f2f2;
        padding: 20px;
        margin: 0;
        }
        
        .page-block {
        max-width: 700px;
        margin: 0 auto;
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h2 {
        text-align: center;
        color: #333;
        margin-bottom: 50px;
        }
        
        .section {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        }
        
        .section label {
        font-weight: 600;
        color: #555;
        margin-bottom: 5px;
        }
        
        .section span {
        font-size: 15px;
        color: #222;
        }
        
        .button-group {
        margin-top: 30px;
        text-align: center;
        }
        
        .button-group button {
        padding: 12px 25px;
        margin: 0 10px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        }
        
        .message {
        padding: 15px;
        margin-top: 25px;
        font-weight: bold;
        border-radius: 6px;
        text-align: center;
        }
        
        .message.success {
        background-color: #d4edda;
        color: #155724;
        }
        
        .message.error {
        background-color: #f8d7da;
        color: #721c24;
        }
        
        .loading {
        text-align: center;
        font-size: 16px;
        color: #666;
        margin-top: 20px;
        }
        
        @media screen and (max-width: 600px) {
        .button-group button {
        margin-top: 10px;
        width: 100%;
        }
        }
    </style>
    
    <div class="page-block" id="gatePassPanel">
        <div  style="text-align: center; margin-bottom: 20px;">
            <h2 style="font-size: 32px; font-weight: bold; color: #333;">Gate Pass Approval</h2>
        </div>
        
        <br/>
        <div id="loadingIndicator" class="loading">Loading order details...</div>
        
        <div class="section"><label>Order Reference:</label> <span id="orderNumber"></span></div>
        <div class="section"><label>VIN/Chassis:</label> <span id="vin"></span></div>
        <div class="section"><label>VRN:</label> <span id="vrn"></span></div>
        <div class="section"><label>Customer:</label> <span id="customer"></span></div>
        <div class="section"><label>Delivery Date:</label> <span id="deliveryDate"></span></div>
        <div class="section"><label>Dealer:</label> <span id="dealer"></span></div>
        <div class="section"><label>Issuer details:</label> <span id="issuerDetails"></span></div>
        
        <div class="button-group" id="actionButtons">
            <button style="color: white;background: #2E8B57;" onclick="approveOrder()" >Approve</button>
            <button style="color: white;background: #D9534F;" onclick="rejectOrder()">Reject</button>
        </div>
        
        <div class="message" id="messageBox" style="display: none;"></div>
    </div>
    
    <script>
    let orderId = new URLSearchParams(window.location.search).get('id');
    
    function showMessage(text, isError) {
        const msg = document.getElementById('messageBox');
        msg.innerText = text;
        msg.className = 'message ' + (isError ? 'error' : 'success');
        msg.style.display = 'block';
        document.getElementById('actionButtons').style.display = 'none';
    }
    
    function formatDate(timestamp) {
        if (!timestamp) return '';
        let date = new Date(Number(timestamp));
        if (isNaN(date.getTime())) return ''; 
        return date.toLocaleDateString();
    }
    function formatDateTime(timestamp) {
        if (!timestamp) return '';
        let date = new Date(Number(timestamp));
        if (isNaN(date.getTime())) return '';
        return date.toLocaleString(); 
    }
    
    
    function loadOrderDetails() {
        if (!orderId) {
            showMessage('Invalid or missing Order ID.', true);
            document.getElementById('loadingIndicator').style.display = 'none';
            return;
        }
        
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.GatePassController.getOrderDetails}',
            orderId,
            function(result, event) {
                document.getElementById('loadingIndicator').style.display = 'none';
                if (event.status && result) {
                    document.getElementById('orderNumber').textContent = result.OrderNumber || '';
                    document.getElementById('vin').textContent = (result.Assigned_Vehicle__r && result.Assigned_Vehicle__r.VehicleIdentificationNumber) || '';
                    document.getElementById('vrn').textContent = (result.Assigned_Vehicle__r && result.Assigned_Vehicle__r.VehicleRegistrationNumber) || '';
                    document.getElementById('customer').textContent = (result.Account && result.Account.Name) || '';
                    document.getElementById('deliveryDate').textContent = formatDate(result.Delivery_Date__c);
                    document.getElementById('dealer').innerHTML = (result.Dealer__r && result.Dealer__r.Name) || '';
                    document.getElementById('issuerDetails').textContent =
                        (result.Gate_Pass_Issuer__c || '') + 
                        (result.Gate_Pass_Generated_Date_Time__c ? ' - ' + formatDateTime(result.Gate_Pass_Generated_Date_Time__c) : '');
                    
                    
                } else {
                    showMessage('Failed to load Order details.', true);
                }
            }
        );
    }
    
    function approveOrder() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.GatePassController.approveGatePass}',
            orderId,
            function(result, event) {
                if (event.status) {
                    showMessage(result, false);
                } else {
                    showMessage('Error approving gate pass: ' + event.message, true);
                }
            }
        );
    }
    
    function rejectOrder() {
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.GatePassController.rejectGatePass}',
            orderId,
            function(result, event) {
                if (event.status) {
                    showMessage(result, false);
                } else {
                    showMessage('Error rejecting gate pass: ' + event.message, true);
                }
            }
        );
    }
    
    window.onload = loadOrderDetails;
    </script>
</apex:page>