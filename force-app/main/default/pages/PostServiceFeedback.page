<!--
@description       : 
@author            : ChangeMeIn@UserSettingsUnder.SFDoc
@group             : 
@last modified on  : 07-17-2025
@last modified by  : ChangeMeIn@UserSettingsUnder.SFDoc
-->
<apex:page controller="PSFController" showHeader="false" sidebar="false" standardStylesheets="false">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>
    <apex:includeScript value="/soap/ajax/43.0/connection.js"/>
    <apex:includeScript value="/soap/ajax/43.0/apex.js"/>
    

    <style>
body {
  font-family: "DM Sans", sans-serif;
  margin: 0;
  background-color: #f9f9f9;
}

.header {
  background-color: #037CB5;
  color: white;
  padding: 10px 0;
  position: relative;
  width: 100%;
  max-width: 100vw;
  height: 64px;
}

.imgbox {
              width: 150px;              
        height: 60px;             
                
        display: flex;
        justify-content: center;
        align-items: center;
          position: absolute;
  left: 2.03px;
  top: 50%
  transform: translateY(-50%);

}

.header-logo {
  height: 100%;
  width: 100%;
}

.user-name {
  font-family: "DM Sans", sans-serif;
  font-weight: 700;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  font-size: 24px;
  color: white;
  width: 526px;
  text-align: center;
}
        
        
        .success-message {
        text-align: center;
        padding: 80px 20px;
        display: none;
        font-family: DM Sans;
        font-weight: 800;
        font-size: 24px;
        line-height: 41.73px;
        letter-spacing: 0%;
        text-align: center;
        }
        
        
        .success-checkmark {
        font-size: 80px;
        color: #4BB543;
        }


h2 {
  font-size: 20px;
  text-align: center;
  line-height: 25px;
  font-weight: 600;
  height: 26px;
  width: 375px;
  margin: 50px auto auto auto;
  padding-bottom: 10px;
  padding-top: 20px;
}

p {
  font-size: 16px;
  color: #878787;
  margin: auto;
  line-height: 25px;
  font-weight: 500;
  height: 42px;
  width: 474px;
  white-space: normal;
}

#feedbackForm {
  display: grid;
  grid-template-columns: repeat(2, auto);
  gap: 20px;
  padding: 20px;
  margin: 40px auto;
  justify-content: center;
        
}
        .addcmnt{
        margin:0px auto 20px auto;
        }

/*  Question Card */
.question-card {
  background: #fff;
  border-radius: 8px;
  border: 1px solid #5E5D5D;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  padding: 20px;
  transition: transform .2s, box-shadow .2s;
  width: 342px;
  height: 256px;
  margin: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  gap: 10px;
}
/* ðŸŽ¯ Center only the last (7th) question card */
        #feedbackForm .question-card:nth-child(7) {
            grid-column: span 2;
            justify-self: center;
        border:1px solid #5E5D5D;
        }
.additionalCommentBox {
  width: 718px !important;
  height: 275px !important;
  margin: 40px auto !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
  background: #fff !important;
  border: 1px solid #5E5D5D !important;
  border-radius: 8px !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  box-sizing: border-box;
}
        #additionalComments{
        
        height:160px;
        width:600px
        }
        
        
        
        
        
}



.question-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.question-title {
  font-size: 14px;
  font-weight: 600;
  color: #333;
        padding:10px;
}
 

/*  Order fix for proper stacking */
.question-card .question-title {
  order: 1;
}
.question-card .option-group {
  order: 2;
}
.question-card textarea {
  order: 3;
}
.question-card .comment-required-message {
  order: 4;
  color: #dc3545;
  font-size: 12px;
  font-weight: bold;
  margin-top: 4px;
}

/* Buttons */
.option-group {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
}

.option-group button {
  flex: 1;
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  transition: background .2s, border-color .2s;
  cursor: pointer;
  height: 36px;
  width: 120px;
}

.option-group button.selected {
  background: #037CB5;
  color: #fff;
  border-color: #037CB5;
}

/* Comment Box */
textarea {
  width: 100%;
  min-height: 80px;
  border: 1px solid #5E5D5D;
  border-radius: 4px;
  padding: 10px;
  font-size: 14px;
  resize: vertical;
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

/* Red validation border */
.required-comment {
  border: 2px solid #dc3545 !important;
  background-color: #fff5f5;
}

/* Submit Button */
#submitBtnWrapper {
  text-align: center;
  margin: 30px 0;
}

#submitBtn {
  background-color: #037CB5;
  color: white;
  border: none;
  padding: 12px 24px;
  font-size: 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

#submitBtn:hover:not(:disabled) {
  background-color: #0369a0;
}

#submitBtn:disabled {
  background-color: #ccc;
  color: #666;
  cursor: not-allowed;
}

/* Stars */
.stars {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  height: 28px;
  width: 216px;
}

.star {
  width: 28px;
  height: 28px;
  fill: white;
  stroke: #c3c3c3;
  stroke-width: 1.5px;
  transition: transform 0.25s ease, fill 0.25s ease;
}

.star:hover {
  transform: scale(1.1);
}

.star.selected path {
  fill: #FFD700;
  stroke: #FFD700;
}

/* Responsive */
@media (max-width: 768px) {
  .header {
    flex-direction: column;
    padding: 16px;
  }

  .user-name {
    font-size: 22px;
    margin-top: 10px;
  }

  #feedbackForm {
    display: block;
    margin: 40px auto;
  }

  .question-card {
    width: 100%;
  }

  textarea {
    font-size: 13px;
  }

  h2 {
    font-size: 20px;
  }

  p {
    font-size: 16px;
  }
}

@media (max-width: 480px) {
        html, body {
    overflow-x: hidden !important;
  }

  /* Ensure full layout fits viewport width */
  body, #feedbackForm, .question-card, .additionalCommentBox, p {
    max-width: 100% !important;
    box-sizing: border-box !important;
  }


 

  .header {
    height: 97px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    width: auto;
  }

  .imgbox {
    position: static;
    width: 122px;
    height: 60px;
    margin: auto;
  }

  .user-name {
    font-weight: 700;
    font-size: 14px;
    position: static;
    transform: none;
  }

  #feedbackForm {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 16px !important;
    padding: 0 0 40px 0 !important;
  }

  #feedbackForm .question-card {
    width: 342px !important;
    min-height: 162px !important;
    background: #fff !important;
    border: 1px solid #5E5D5D !important;
    border-radius: 20px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
    text-align: center !important;
    gap: 6px !important;
    box-sizing: border-box !important;
    padding: 12px 8px !important;
    margin-top: 12px;
  }

  .option-group button {
    width: 120px !important;
    height: 36px !important;
  }

  textarea {
    width: 90% !important;
    min-height: 80px !important;
    border-radius: 8px !important;
        
  }
        .additionalCommentBox {
  width: 342px !important;
  height: 275px !important;
  margin: 40px auto !important;

}
        #additionalComments{
        
        height:165px;
        width:298px
        }

  #submitBtnWrapper {
    margin-top: 24px !important;
  }

  #submitBtn {
    width: 90% !important;
    max-width: 340px !important;
  }
        p{
        width:340px;
        height:62px;
        

        }
}
</style>

    <div class="header">
          <div class="imgbox">
            <img src="{!URLFOR($Resource.Ride_River_Logo_LWC)}" alt="Ride River Logo" class="header-logo" />
        </div>
        
        <apex:outputPanel rendered="{!NOT(ISNULL(primaryContact))}">
            <div class="user-name"><span class="highlight">Hi!</span> {!primaryContact.Name}</div>
        </apex:outputPanel>
    </div>
    
    <!-- Main Content -->
    <div id="mainContent" style="text-align: center;">
        <h2>We'd love your feedback!</h2>
        <p>
            We're always looking to improve your River experience.
            <!-- Share your thoughts to help us keep getting better. -->
            Share a quick rating to help us keep getting better.
        </p>
        
        <div id="feedbackForm">
            <!-- Questions will be dynamically rendered here -->
        </div>
        
        <!-- Additional Comments Section -->
        <div class="additionalCommentBox">
            <div class="question-title"><h3 class="addcmnt">
                Additional Comments
                </h3></div>
            <textarea id="additionalComments" 
                placeholder="Write your comments here..."
                      
                ></textarea>
        </div>
        
        <div id="submitBtnWrapper">
            <button id="submitBtn" disabled="disabled">Submit Feedback</button>
        </div>
    </div>
    
    <!-- Success Message for first submission -->
    <div class="success-message" id="thankYouMessage" style="display:none;">
        <div class="success-checkmark">&#10004;</div>
        <h2>Thank You for Your Feedback!</h2>
        <p>We appreciate you taking the time to share your experience with us.<br/>
            Your feedback helps us improve our services.
        </p>
    </div>
    
    <!-- Already Submitted Message -->
    <div class="success-message" id="alreadySubmittedMessage" style="display:none;">
        <div class="success-checkmark">&#10004;</div>
        <h2>Feedback Already Submitted</h2>
        <p>Thanks for sharing your thoughts! We've already received your feedback.<br/>
            If you need to update or have more to say, feel free to contact our team.
        </p>
    </div>
    
    <!-- Expired Message -->
    <div class="expired-message" id="expiredMessage" style="display:none;">
        <div class="expired-icon">âš </div>
        <h2>Oops! This Link isn't active anymore</h2>
        <p>Looks like this feedback link has expired or been used already.</p>
    </div>
    
    <div id="errorMessage"></div>

    <!-- JavaScript -->
    <script>
        let leadId = null;
        let responseId = null;
        const responses = {};
        
        const questions = [
            { id: 'q1', text: 'Did you receive a call from the Service Team after your Indie was serviced?', type: 'yesno' },
            { id: 'q2', text: 'How convenient was it to schedule a service appointment for your Indie?', type: 'stars' },
            { id: 'q3', text: 'How helpful was the Service Advisor in resolving your issues?', type: 'stars' },
            { id: 'q4', text: 'Were the job card and invoice provided and explained to you?', type: 'yesno' },
            { id: 'q5', text: 'How clean was the delivered vehicle after service?', type: 'stars' },
            { id: 'q6', text: 'How effectively was your issue resolved during the service?', type: 'stars' },
            { id: 'q7', text: 'Was your Indie\'s service completed on time?', type: 'yesno' }
            /*{ id: 'q7', text: 'Was your Indie service completed on time?', type: 'yesno' }*/
        ];
        
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        
        function renderQuestions() {
            const form = document.getElementById('feedbackForm');
            form.innerHTML = '';
        
             questions.forEach(q => {
                 const container = document.createElement('div');
                 container.classList.add('question-card');
                 container.setAttribute('data-question-id', q.id);
        
                const label = document.createElement('div');
                label.textContent = q.text;
                label.className = 'question-title';
                container.appendChild(label);
        
                // Initialize response structure for this question
                responses[q.id] = {
                    Question__c: q.text,
                    Answer__c: null,
                    Rating__c: null,
                    Comments__c: '',
                    Question_Type__c: q.type
                };
        
                if (q.type === 'stars') {
                    const starDiv = document.createElement('div');
                    starDiv.className = 'stars';
        
                     const commentBox = document.createElement('textarea');
                     commentBox.placeholder = 'What did not work?';
                     commentBox.style.width = '100%';
                     commentBox.style.marginTop = '8px';
                     commentBox.style.display = 'none';
                     commentBox.style.border = '1px solid #ccc';
                     commentBox.style.borderRadius = '4px';
                     commentBox.style.padding = '8px';
                     commentBox.required = true;
                     container.appendChild(commentBox);
        
for (let i = 1; i <= 5; i++) {
    const star = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    star.classList.add('star');
    star.setAttribute('data-value', i);
    star.setAttribute('viewBox', '0 0 24 24');
    star.setAttribute('width', '24');
    star.setAttribute('height', '24');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M12 2.5l2.9 5.9 6.6.9-4.8 4.5 1.2 6.5L12 17.8 6.1 20.3l1.2-6.5L2.5 9.3l6.6-.9L12 2.5z');

    star.appendChild(path);

    star.addEventListener('click', () => {
        responses[q.id].Rating__c = i;
        responses[q.id].Answer__c = i.toString();
        responses[q.id].Selected_Option__c = null;

        updateStars(starDiv, i);

        if (i <= 3) {
            commentBox.style.display = 'block';
        } else {
            commentBox.style.display = 'none';
            commentBox.value = '';
            responses[q.id].Comments__c = '';
        }

        checkCompletion();
    });

    starDiv.appendChild(star);
}


        
                     commentBox.addEventListener('input', function() {
                         responses[q.id].Comments__c = commentBox.value;
                         checkCompletion();
                     });
         
                     container.appendChild(starDiv);
                } else if (q.type === 'yesno') {
                    const buttonContainer = document.createElement('div');
                    buttonContainer.classList.add('option-group');
        
                     const commentBox = document.createElement('textarea');
                     commentBox.placeholder = 'What did not work?';
                     commentBox.style.width = '100%';
                     commentBox.style.marginTop = '8px';
                     commentBox.style.display = 'none';
                     commentBox.style.border = '1px solid #ccc';
                     commentBox.style.borderRadius = '4px';
                     commentBox.style.padding = '8px';
                     commentBox.required = true;
                     container.appendChild(commentBox);
        
                    ['Yes', 'No'].forEach(option => {
                        const btn = document.createElement('button');
                        btn.textContent = option;
                        btn.type = 'button';
        
                        btn.addEventListener('click', () => {
                            responses[q.id].Selected_Option__c = option;
                            responses[q.id].Answer__c = option;
                            responses[q.id].Rating__c = null;
        
                            highlightSelected(btn, buttonContainer);
        
                            if (option === 'No') {
                                commentBox.style.display = 'block';
                            } else {
                                commentBox.style.display = 'none';
                                commentBox.value = '';
                                responses[q.id].Comments__c = '';
                            }
        
                            checkCompletion();
                        });
        
                        buttonContainer.appendChild(btn);
                    });
        
                     commentBox.addEventListener('input', function() {
                         responses[q.id].Comments__c = commentBox.value;
                         checkCompletion();
                     });
         
                     container.appendChild(buttonContainer);
                }
        
                form.appendChild(container);
            });
        }
        
        function updateStars(container, value) {
            const stars = container.querySelectorAll('.star');
            stars.forEach(star => {
                const val = parseInt(star.getAttribute('data-value'));
                if (val <= value) {
                    star.style.color = '#FFD700';
                    star.classList.add('selected');
                } else {
                    star.style.color = '#ccc';
                    star.classList.remove('selected');
                }
            });
        }
        
        function highlightSelected(selectedButton, container) {
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });
            selectedButton.classList.add('selected');
        }
        
         function checkCompletion() {
            debugger;
             let allAnswered = true;
             let hasValidationErrors = false;
             
             // Clear previous error messages
             document.querySelectorAll('.comment-required-message').forEach(msg => msg.remove());
             document.querySelectorAll('.required-comment').forEach(el => {
                 el.classList.remove('required-comment');
                 el.style.backgroundColor = '';
             });
             
             questions.forEach(q => {
                 const response = responses[q.id];
                 if (!response || (response.Rating__c === null && response.Selected_Option__c === null)) {
                     allAnswered = false;
                     console.log('allAnswered : ' + allAnswered);
                 } else {
                     // Check if "No" was selected and comment is required
                     if (q.type === 'yesno' && response.Selected_Option__c === 'No') {
                         if (!response.Comments__c || response.Comments__c.trim() === '') {
                             hasValidationErrors = true;
                             addCommentRequiredIndicator(q.id, 'Comment is required when selecting "No"');
                         }
                     }
                     // Check if low rating (1-3) was selected and comment is required
                     if (q.type === 'stars' && response.Rating__c !== null && response.Rating__c <= 3) {
                         if (!response.Comments__c || response.Comments__c.trim() === '') {
                             hasValidationErrors = true;
                             addCommentRequiredIndicator(q.id, 'Comment is required for ratings 1-3');
                         }
                     }
                 }
             });
         
             const submitBtn = document.getElementById('submitBtn');
             if (allAnswered && !hasValidationErrors) {
                 submitBtn.disabled = false;
             } else {
                 submitBtn.disabled = true;
             }
         }
         
         function addCommentRequiredIndicator(questionId, message) {
             const questionCard = document.querySelector(`[data-question-id="${questionId}"]`);
             if (questionCard) {
                 const commentBox = questionCard.querySelector('textarea');
                 if (commentBox) {
                     commentBox.classList.add('required-comment');
                     
                     // Add error message if not already present
                     if (!commentBox.nextElementSibling || !commentBox.nextElementSibling.classList.contains('comment-required-message')) {
                         const errorMsg = document.createElement('div');
                         errorMsg.className = 'comment-required-message';
                         errorMsg.textContent = message;
                         commentBox.parentNode.insertBefore(errorMsg, commentBox.nextSibling);
                     }
                 }
             }
         }
        
        function showErrorAndDisable(message) {
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) {
                errorEl.innerText = message;
            }
            document.getElementById('submitBtn').disabled = true;
        }
        
        function isLinkExpired(sentDateTime) {
            const sentDate = new Date(sentDateTime);
            const currentDate = new Date();
            const diffHours = Math.abs(currentDate - sentDate) / 36e5;
            return false;
        }
        
        function showExpiredMessage() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('thankYouMessage').style.display = 'none';
            document.getElementById('alreadySubmittedMessage').style.display = 'none';
            document.getElementById('expiredMessage').style.display = 'block';
        }
        
        function showAlreadySubmittedMessage() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('thankYouMessage').style.display = 'none';
            document.getElementById('alreadySubmittedMessage').style.display = 'block';
            document.getElementById('expiredMessage').style.display = 'none';
        }
        
        function showThankYouMessage() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('thankYouMessage').style.display = 'block';
            document.getElementById('alreadySubmittedMessage').style.display = 'none';
            document.getElementById('expiredMessage').style.display = 'none';
        }
        
        function checkExistingFeedback() {
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.PSFController.checkExistingFeedback}',
                leadId,
                function(result, event) {
                    if (event.status) {
                        if (result) {
                            if (result.Sent_Date_Time__c) {
                                const isExpired = isLinkExpired(result.Sent_Date_Time__c);
                                if (isExpired) {
                                    showExpiredMessage();
                                    return;
                                }
                            }
                            
                            if (result.Response_Status__c && result.Response_Status__c.toLowerCase() === 'submitted') {
                                showAlreadySubmittedMessage();
                                return;
                            }
                            
                            responseId = result.Id;
                            renderQuestions();
                        } else {
                            initializeFeedbackSession();
                        }
                    } else {
                        console.error('Error checking existing feedback:', event.message);
                        showErrorAndDisable('Error loading feedback form.');
                    }
                }
            );
        }
        
        function initializeFeedbackSession() {
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.PSFController.createEmptyResponse}',
                leadId,
                function(newId, event) {
                    if (event.status && newId !== null) {
                        responseId = newId;
                        renderQuestions();
                    } else {
                        showErrorAndDisable('Failed to initialize feedback session.');
                    }
                }
            );
        }
        
         function submitFeedback() {
             if (!responseId) {
                 alert('Feedback session not initialized.');
                 return;
             }
             
             // Final validation before submission
             let validationErrors = [];
             questions.forEach(q => {
                 const response = responses[q.id];
                 if (!response || (response.Rating__c === null && response.Selected_Option__c === null)) {
                     validationErrors.push(`Please answer: ${q.text}`);
                 } else {
                     // Check if "No" was selected and comment is required
                     if (q.type === 'yesno' && response.Selected_Option__c === 'No') {
                         if (!response.Comments__c || response.Comments__c.trim() === '') {
                             validationErrors.push(`Please provide a comment for: ${q.text}`);
                         }
                     }
                     // Check if low rating (1-3) was selected and comment is required
                     if (q.type === 'stars' && response.Rating__c !== null && response.Rating__c <= 3) {
                         if (!response.Comments__c || response.Comments__c.trim() === '') {
                             validationErrors.push(`Please provide a comment for: ${q.text}`);
                         }
                     }
                 }
             });
             
             if (validationErrors.length > 0) {
                 alert('Please complete the following:\n\n' + validationErrors.join('\n'));
                 return;
             }
         
             const additionalComments = document.getElementById('additionalComments').value || '';
             
             console.log('Submitting feedback with responseId:', responseId);
             console.log('Responses data:', JSON.stringify(responses, null, 2));
             
             // Convert responses to FeedbackResponsesWrapper structure
             const responsesWrapper = {
                 responses: []
             };
             
             // Convert the responses object to the wrapper format
             Object.keys(responses).forEach(key => {
                 const response = responses[key];
                 responsesWrapper.responses.push({
                     question: response.Question__c,
                     Rating: response.Rating__c,
                     SelectedOption: response.Selected_Option__c,
                     Comments: response.Comments__c,
                     Answer: response.Answer__c
                 });
             });
             
             console.log('Converted to FeedbackResponsesWrapper:', JSON.stringify(responsesWrapper, null, 2));
         
             // Use the updated saveFeedback method with FeedbackResponsesWrapper
             Visualforce.remoting.Manager.invokeAction(
                 '{!$RemoteAction.PSFController.saveFeedback}',
                 responseId,
                 responsesWrapper,  // FeedbackResponsesWrapper
                 leadId,
                 window.location.href,
                 additionalComments,
                 function(result, event) {
                     if (event.status) {
                         showThankYouMessage();
                     } else {
                         alert('There was an error submitting your feedback: ' + event.message);
                         console.error('Submission error:', event);
                     }
                 }
             );
         }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('submitBtn').addEventListener('click', submitFeedback);
            
            leadId = getUrlParameter('id');
            console.log('Lead ID from URL:', leadId);
            
            if (!leadId) {
                showErrorAndDisable('Invalid link. Lead ID not found.');
                return;
            }
            
            checkExistingFeedback();
        });
    </script>
</apex:page>